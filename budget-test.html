<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Management Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-8">
        <h1 class="text-3xl font-bold mb-8">AgroSakha Budget Management</h1>
        
        <!-- Current Budget Display -->
        <div id="currentBudget" class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Current Month Budget</h2>
            <div id="budgetInfo">Loading...</div>
        </div>

        <!-- Create Budget Form -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Create New Budget</h2>
            <form id="budgetForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                        <select id="month" class="w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7" selected>July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                        <input type="number" id="year" value="2025" class="w-full p-2 border border-gray-300 rounded-md" min="2020" max="2030" required>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Total Budget ($)</label>
                    <input type="number" id="totalBudget" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter total budget" min="0" step="0.01" required>
                </div>

                <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                    Create Budget
                </button>
            </form>
        </div>

        <!-- Test Expense Form -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Add Test Expense</h2>
            <form id="expenseForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount ($)</label>
                        <input type="number" id="expenseAmount" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter amount" min="0" step="0.01" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                        <select id="expenseCategory" class="w-full p-2 border border-gray-300 rounded-md" required>
                            <option value="Seeds & Fertilizers">Seeds & Fertilizers</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Labor">Labor</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <input type="text" id="expenseDescription" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter description">
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                    Add Expense
                </button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000';

        // Load current budget
        async function loadCurrentBudget() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/budgets/current`);
                const budgetInfo = document.getElementById('budgetInfo');
                
                if (response.status === 404) {
                    budgetInfo.innerHTML = `
                        <div class="text-gray-600">
                            <p>No budget set for current month.</p>
                            <p>Create a budget below to start tracking your expenses!</p>
                        </div>
                    `;
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load budget');
                }

                const data = await response.json();
                const { budget, spending } = data;

                budgetInfo.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">$${budget.totalBudget.toLocaleString()}</div>
                            <div class="text-sm text-gray-600">Total Budget</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold ${spending.isOverBudget ? 'text-red-600' : 'text-green-600'}">
                                $${spending.totalSpent.toLocaleString()}
                            </div>
                            <div class="text-sm text-gray-600">Spent</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold ${spending.remaining < 0 ? 'text-red-600' : 'text-blue-600'}">
                                $${Math.abs(spending.remaining).toLocaleString()}
                            </div>
                            <div class="text-sm text-gray-600">${spending.remaining < 0 ? 'Over Budget' : 'Remaining'}</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Budget Progress</span>
                            <span>${spending.percentage.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-300 ${
                                spending.isOverBudget ? 'bg-red-500' : 
                                spending.percentage > 80 ? 'bg-yellow-500' : 'bg-green-500'
                            }" style="width: ${Math.min(spending.percentage, 100)}%"></div>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('budgetInfo').innerHTML = `
                    <div class="text-red-600">Error loading budget: ${error.message}</div>
                `;
            }
        }

        // Create budget form handler
        document.getElementById('budgetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const budgetData = {
                month: parseInt(document.getElementById('month').value),
                year: parseInt(document.getElementById('year').value),
                totalBudget: parseFloat(document.getElementById('totalBudget').value)
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/budgets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(budgetData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create budget');
                }

                alert('Budget created successfully!');
                document.getElementById('budgetForm').reset();
                loadCurrentBudget();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });

        // Add expense form handler
        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const expenseData = {
                amount: parseFloat(document.getElementById('expenseAmount').value),
                category: document.getElementById('expenseCategory').value,
                description: document.getElementById('expenseDescription').value,
                date: new Date().toISOString()
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/expenses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expenseData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add expense');
                }

                alert('Expense added successfully!');
                document.getElementById('expenseForm').reset();
                loadCurrentBudget(); // Refresh budget display
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });

        // Load current budget on page load
        loadCurrentBudget();
    </script>
</body>
</html>
